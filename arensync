#!env zsh
function readconf
{
. `dirname $0`/default.conf
. "$1"
checkconf "$1"
}

function fail
{
echo "$1" 1>&2;
exit 1
}

function checkconf
{
[[ -z "$workdir" ]] && fail "$workdir does not exist!"
[[ -z "$serveruser" || -z "$server" || -z "$serverdir" ]]  && 
    fail "Wrong server configuration $1 with user: $serveruser server: $server and dir $serverdir";
"$sshbin" "$serveruser@$server" "[[ -d \"$serverdir\" ]]" || fail "$serverdir does not exist on $server"
touch "$arensynctempdir/test" || fail "Tempdir $arensynctempdir isn't writable."
"$gpgbin" -r "$email" --encrypt "$arensynctempdir/test" || { rm "$arensynctempdir/test"; fail "gpg not working - failed to encrypt"}
rm "$arensynctempdir/test" "$arensynctempdir/test.gpg"

}

function archiveencrypt
{
"$sshbin" "$serveruser@$server" "f=($serverdir/*.lst); ls ${f[@]} | sort -r | xargs cat | sed 's/  / /g' |  sort -k2,2 -u" > serverfiles
find "$workdir" -type f -name "*" -print0 | xargs -0 -n 1 -P 10 sh -c 'sha256sum "$1"' sh | sed 's/  / /g' > localfiles
toupload=$(sort localfiles serverfiles serverfiles | uniq -u)
rm localfiles serverfiles
[[ -z toupload ]] && fail "Nothing new upload!"
archive="`date +archive%Y%m%d_%H%M%S.tar.gz`"
archivepath="$arensynctempdir/$archive"
echo "$toupload" > "$archivepath.lst"
tar czvf "$archivepath" "$toupload" || fail "Couldn't create archive!"
"$gpgbin" -r "$email" --encrypt "$archivepath"
sha256sum "$archivepath.gpg" > "$archivepath.gpg.sum"
rm "$archivepath"
}

function upload
{
echo "$archivepath" > "$arensynctempdir/.uploading"
"$rsyncbin" "$archivepath.{gpg,gpg.sum,lst}" "$serveruser@$server:$serverpath/" || fail "Error while uploading"
rm "$arensynctempdir/.uploading"
}

if [[ -z "$1" ]]; then
conff=(${HOME}/.config/arensync/*.conf)
for f in "${conff[@]}"; do
readconf "$f"
findchanged
done;

fi
